receivers:
    otlp:
        protocols:
            grpc:
                endpoint: 0.0.0.0:4317
            http:
                endpoint: 0.0.0.0:4318

processors:
    memory_limiter:
        check_interval: 1s
        limit_mib: 512
        spike_limit_mib: 128
    batch:
        timeout: 1s

    # Tail-based sampling: keep error/slow electric-proxy traces, sample 10% of the rest
    tail_sampling:
        decision_wait: 10s
        num_traces: 100000
        policies:
            # Pass through all non-electric-proxy services at 100%
            - name: keep-other-services
              type: string_attribute
              string_attribute:
                  key: service.name
                  values: [api, cluster]

            # Always keep electric-proxy error traces
            - name: keep-ep-errors
              type: and
              and:
                  - name: is-ep
                    type: string_attribute
                    string_attribute:
                        key: service.name
                        values: [electric-proxy]
                  - name: has-error
                    type: status_code
                    status_code:
                        status_codes: [ERROR]

            # Always keep electric-proxy traces > 500ms
            - name: keep-ep-slow
              type: and
              and:
                  - name: is-ep
                    type: string_attribute
                    string_attribute:
                        key: service.name
                        values: [electric-proxy]
                  - name: slow
                    type: latency
                    latency:
                        threshold_ms: 500

            # Sample 10% of remaining electric-proxy traces
            - name: sample-ep-baseline
              type: and
              and:
                  - name: is-ep
                    type: string_attribute
                    string_attribute:
                        key: service.name
                        values: [electric-proxy]
                  - name: probabilistic
                    type: probabilistic
                    probabilistic:
                        sampling_percentage: 10

    # Drop electric-proxy INFO/DEBUG logs, keep WARN and above
    filter/ep-routine-logs:
        error_mode: ignore
        logs:
            log_record:
                - 'resource.attributes["service.name"] == "electric-proxy" and severity_number < 13'

exporters:
    otlphttp/maple:
        endpoint: https://ingest.maple.dev
        headers:
            Authorization: "Bearer ${env:MAPLE_INGEST_KEY}"

service:
    pipelines:
        traces:
            receivers: [otlp]
            processors: [memory_limiter, tail_sampling, batch]
            exporters: [otlphttp/maple]
        metrics:
            receivers: [otlp]
            processors: [memory_limiter, batch]
            exporters: [otlphttp/maple]
        logs:
            receivers: [otlp]
            processors: [memory_limiter, filter/ep-routine-logs, batch]
            exporters: [otlphttp/maple]
