receivers:
    otlp:
        protocols:
            grpc:
                endpoint: 0.0.0.0:4317
            http:
                endpoint: 0.0.0.0:4318

processors:
    resource/maple_org:
        attributes:
            - key: maple_org_id
              action: upsert
              value: ${env:MAPLE_ORG_ID}

    batch:
        timeout: 5s
        send_batch_size: 8192

    # Probabilistic sampling for traces (10% sample rate)
    probabilistic_sampler:
        sampling_percentage: 10

exporters:
    debug:
        verbosity: basic
        sampling_initial: 5
        sampling_thereafter: 200

    tinybird:
        endpoint: ${OTEL_TINYBIRD_API_HOST}
        token: ${OTEL_TINYBIRD_TOKEN}
        wait: true
        metrics:
            gauge:
                datasource: "metrics_gauge"
            sum:
                datasource: "metrics_sum"
            histogram:
                datasource: "metrics_histogram"
            exponential_histogram:
                datasource: "metrics_exponential_histogram"
        traces:
            datasource: "traces"
        logs:
            datasource: "logs"
        retry_on_failure:
            enabled: true
        sending_queue:
            enabled: true
            queue_size: 104857600 # 100 MB total buffer size
            sizer: bytes
            batch:
                flush_timeout: 5s
                min_size: 1024 # 1 KB min batch size (lowered for faster flushes)
                max_size: 10000000 # ~10 MB max batch size

service:
    telemetry:
        logs:
            level: info
    pipelines:
        traces:
            receivers: [otlp]
            processors: [resource/maple_org, probabilistic_sampler, batch]
            exporters: [debug, tinybird]
        metrics:
            receivers: [otlp]
            processors: [resource/maple_org, batch]
            exporters: [debug, tinybird]
        logs:
            receivers: [otlp]
            processors: [resource/maple_org, batch]
            exporters: [debug, tinybird]
